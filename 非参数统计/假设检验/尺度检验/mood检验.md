# Mood检验

## 1. 问题引入

**问题**：如何检验下面两组数据的方差是否相等？

```r
X = c(698, 688, 675, 656, 655, 648, 640, 639, 620)
Y = c(780, 754, 740, 712, 693, 680, 621)
```

一个很直观的想法是直接分别计算$X$数据的方差和$Y$数据的方差，然后利用它们的比值构造检验统计量。然而，这样得到的检验统计量的分布**完全依赖于两组数据本身服从的分布**。仅当两组数据都服从正态分布时，在原假设下，它们的方差之比才服从$F$分布。

非参数统计的基本思路是把真实样本数据映射到秩，从而让构造的检验统计量**不依赖于原始数据的分布**。例如，我们可以直接将$X$和$Y$数据分别映射成秩：

```r
> rank(X)
[1] 9 8 7 6 5 4 3 2 1

> rank(Y)
[1] 7 6 5 4 3 2 1
```

但我们马上发现，此时$X$或$Y$的方差变得毫无意义。因为这种**基于各自样本内部**映射得到的秩服从均匀分布，此时的样本方差大小完全取决于样本量。

**关键洞察**：要让秩能反映原始数据的变异性，可以考虑往原始数据中插入更多和它相似的数据。想象一下，如果把样本$X$混合到一个和自己相似的样本$Z$中：

```r
z = c(644, 652, 697, 659, 661, 701, 669, 626, 640, 647)
combine = c(x, z)

> rank(x)
[1] 18.0 16.0 15.0 11.0 10.0  8.0  4.5  3.0  1.0
```

可以看到，混合后$X$的秩不再是均匀分布，而是有了变异性！

基于这种思想，Mood提出了他的同方差检验：
- 假定$X$和$Y$**中心位置相同**（这是关键前提）
- 将两组数据混合排序，计算每个数据在混合样本中的秩
- 通过分析秩的分布来推断原始数据的变异性

**为什么需要中心位置相同的假设？**
如果两份数据的中心位置不同，比如$X$中的数据全部小于$Y$，那么$X$映射到的秩依然是相对均匀的，无法真实反映其变异性。

## 2. 检验统计量

先将$X$和$Y$数据混合排序，得到$X$样本中每个数据在混合样本中的秩，记为$R_{x_i}$。设$X$和$Y$的样本量分别为$m$和$n$。

Mood检验统计量为：
$$
M_x = \sum_{i=1}^{m} \left(R_{x_i} - E(R)\right)^2
$$

其中，$E(R)$是理论平均秩. 用$I_i$ 表示秩 $i$ 是否被分配到第一个样本的指示变量，则$P(I_i = 1) = \frac{1}{m + n}$，因此：
$$E(R) = \sum_{i=1}^{m+n} i \cdot P(I_i = 1) = \frac{1 + m + n}{2}$$

**补充解释**：
- 形似方差，但缺少系数$\frac{1}{m}$.（这个系数体现在拒绝域的临界值中）
- $M_x$不能精确反映$X$的方差，但和$X$的单调性是一致的。即$X$的方差增大，$M_x$也增大。
- $M_x = M_y$并不能说明$X$和$Y$方差接近。因为样本量大的一方离差平方和总是会更大的，因此$M_x$和$M_y$之间应该呈现**合理比例**。


## 3. 拒绝域

检验问题：
$$H_0: \sigma_x^2 = \sigma_y^2 \leftrightarrow H_1: \sigma_x^2 \neq \sigma_y^2$$

**重要性质**：$M_x + M_y =$ 常数（混合样本的总离差平方和）
注意这个性质是秩的天然特性。就像$W_x + W_y = $常数 一样。由秩组成的样本计算得到的统计量总是确定的常数。

这个性质决定了拒绝域的形式：
- 如果$M_x$**足够**小 → $M_y$很大 → $X$的方差小于$Y$
- 如果$M_x$**足够**大 → $M_y$很小 → $X$的方差大于$Y$  
- 如果$M_x$适中 → $M_y$也适中 → 表明两组方差相近

因此，无论$M_x$偏大还是偏小，都意味着方差不相等。$M_x$的拒绝域是：
$$M_x < c_0 \quad 或 \quad M_x > c_1$$

其中$c_0$和$c_1$是根据显著性水平和样本量确定的临界值。

## 4. 精确分布和近似分布

**精确分布**：对于小样本情况，可以查Mood检验的临界值表。计算精确分布的思想与Wilcoxon符号秩检验类似，基于秩的所有可能排列。

**近似分布**：对于大样本情况，可以使用正态近似。Mood统计量的期望和方差为：

- $E(M_x) = \dfrac{m(m + n + 1)(m + n - 1)}{12}$
- $D(M_x) = \dfrac{mn(m + n + 1)(m + n + 2)(m + n - 2)}{180}$

标准化统计量：
$$Z = \frac{M_x - E(M_x)}{\sqrt{D(M_x)}} \stackrel{\cdot}{\sim} N(0,1)$$

两种修正策略：
- 分子 $+-0.5$
- 整体 $+ \frac{1}{2\sqrt{D(M_x)}}$

## 5.更进一步的思考与实践
问：我们在开头提到，$mood$检验的核心假设是两样本的中心位置相同。对应任意两份大致对称的数据，我们都可以通过平移变换来使它们的中心位置对齐。这样**只要中心对称的两份数据总是能进行mood检验**？

答案是否定的。
- 平移变换确实能使任意两个**样本**的中心位置对齐且平移不改变$X$的**原始数据**方差；但平移影响了$X$在混合样本中的秩，进而改变了$X$的**秩**方差。
- 平移量是基于**样本数据**动态计算的，这会让两个总体的真实中心位置差异时大时小，使得$X$的混合样本秩不再能稳定反映它的真实方差；
- 除非我们真的知道或者能非常准确地估计两个样本的中心位置，这样我们平移时总是使用一个确定的偏移量，而不是"动态计算"。

因此，标准的实践过程：
```r
X = c(698, 688, 675, 656, 655, 648, 640, 639, 620)
Y = c(780, 754, 740, 712, 693, 680, 621)

> wilcox.test(x = X, y = Y, alternative = "two.sided")

	Wilcoxon rank sum exact test

data:  X and Y
W = 11, p-value = 0.03112
alternative hypothesis: true location shift is not equal to 0
```
p-value < 0.05，不能认为两样本的中心位置相同。因此不能继续进行mood检验。但假设我们知道$X$和$Y$的真实中心位置差为4，于是让$Y$样本数据总体向左偏移4个单位，得到：
```
Y = Y - 4
> Y
[1] 776 750 736 708 689 676 617
```
再进行mood检验。先简单计算一下$X$和$Y$的方差，确定单侧检验的方向：
```
> sd(X)
[1] 25.07489
> sd(Y)
[1] 52.97124
```
猜测总体分布的方差$X$比$Y$小，于是进行左侧检验：
```
> mood.test(x = X, y = Y, alternative = "less")

	Mood two-sample test of scale

data:  X and Y
Z = -1.627, p-value = 0.05187
alternative hypothesis: less
```
p值略大于0.05，因此我们不能拒绝原假设，无法证明总体分布中$X$的方差小于$Y$.
