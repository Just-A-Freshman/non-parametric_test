# Moses检验
## 1. 思考引入
知识是环环相扣的。回顾$mood$检验，它将数据的大小转化成混合样本中的秩，最后再利用类似方差的统计量做检验。这其中最大的问题在于两点：
- 依赖于总体中心位置相同的假设，这一前提在实际应用中往往难以满足；
- 过早地压缩了原始数据的变异性。第一步就将数值信息简化为秩次，损失了部分信息量。

$Moses$检验通过**分组**+**先求离差后求秩**的策略解决了上述问题。

## 2. 实际操作
### 2.1 步骤
1. **确定分组大小**：选择合适的分组样本量K，通常介于3~10之间，要求两组的分组大小相同。

2. **随机分组**：分别对X和Y样本进行随机分组，无法组成完整分组的多余数据予以剔除。

3. **计算组内离差平方和**：对每个分组计算离差平方和：
   $$SS = \sum_{i=1}^{K}(x_i - \bar{x})^2$$

4. **秩和检验**：对两组样本的离差平方和进行Wilcoxon秩和检验。

### 2.2 例子
假设我们有以下已经打乱的数据：
```
X = [2, 4, 8, 6, 9, 10, 5, 3, 1, 11, 7]
Y = [1, 6, 3, 7, 2, 1, 6, 3, 3]
```
**步骤1**：确定K=3
**步骤2**：随机分组。因为$X$和$Y$已经打乱，我们从左往右每三个数据作为一组。注意$X$最后多出的两个数据要剔除。于是：
```
X = [(2, 4, 8), (6, 9, 10), (5, 3, 1)]
Y = [(1, 6, 3), (7, 2, 1), (6, 3, 3)]
```
**步骤3**：计算离差平方和。例如，对于$Y$的第三个分组数据$(6, 3, 3)$，它的均值为4，离差平方和是$(2 - 4)^2 + (3 - 4)^2 + (3 - 4)^2 = 6$。依次类推，$X$和$Y$的数据最终就变成了：
```
X = [18.65, 8.67, 8.00]
Y = [12.67, 20.67, 6.00]
```
**步骤4**：对新的数据集进行Wilcoxon秩和检验。此处不做赘述。

### 2.3 R语言实现
通过理解上述步骤，我们很容易对$Moses$检验进行相应的实现：
```r
moses.test <- function(
    X,
    Y,
    K=3,
    alternative = c("two.sided", "less", "greater"),
    correct = TRUE,
    conf.level = 0.95
  ){
  m1 <-  floor(length(X) / K)
  m2 <-  floor(length(Y) / K)

  if (m1 == 0 || m2 == 0) {
    stop("样本量太少，无法进行分组!")
  }

  shuffled_X <- sample(X)[1:(m1 * K)]
  shuffled_Y <- sample(Y)[1:(m2 * K)]

  X_groups <- split(shuffled_X, rep(1:m1, each = K))
  Y_groups <- split(shuffled_Y, rep(1:m2, each = K))

  calc_ss = function(x){sum((x - mean(x))^2)}
  new_X = vapply(X_groups, calc_ss, numeric(1))
  new_Y = vapply(Y_groups, calc_ss, numeric(1))

  return(wilcox.test(new_X, new_Y, alternative, correct, conf.level))
}


set.seed(123)
X = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
Y = c(1, 6, 3, 7, 2, 1, 6, 3, 3)
result = moses.test(X, Y)

sample(X)
```

## 3. 关于有效性的思考
### 3.1 解决的核心问题

1. **摆脱中心位置假设**：Moses检验基于分组均值计算离差，不要求总体中心位置相同，适用范围更广。

2. **更多地保留数据变异性**：通过"先求离差后求秩"的策略，在秩转换前充分保留了原始数据的变异信息。

### 3.2 追问
一个自然的想法是：为什么不直接计算各数据点与中位数的距离，然后进行Wilcoxon检验？
例如，对于上述数据，$X$的中位数是6,$Y$的中位数是3。我们直接将数据转化成与中位数的距离，于是：
```
X = c(5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5)
Y = c(2, 3, 3, 4, 1, 2, 3, 0, 0)
```
最后直接进行秩和检验。乍一看好像简单粗暴，确实保留了更多的数据，并且"和中位数的距离"确实能反映总体的"方差"大小啊？

我认为最重要的原因是：**绝对离差的分布不是对称分布**，而wilcox检验要求数据必须是对称的。
对于样本数据，距离中心远的极端值是少数，而距离中位数近的才是大多数。因此绝对离差的分布是**右偏**的；而$Moses$分很巧妙地使本来右偏的离差数据通过随机分组求和变得**均匀**了。
另外，分组操作还平缓了极端值的影响。极端值成为一个分组中的成员，它的极端性因为分组而被中和。


## 4. 局限性与注意事项
### 4.1 主要局限性

1. **随机性影响**：分组过程的随机性可能导致结果波动，建议对同一数据重复检验多次以提高结果可靠性。

2. **样本量要求**：分组后有效样本量大幅减少（约为原样本量的1/K），需要较大的初始样本量。

3. **数据损失**：无法参与分组的剩余数据被剔除，造成信息损失。

4. **分组大小选择**：K值的选择需要权衡，过小则离差估计不稳定，过大则分组数量减少，可能导致"**过度均匀**"，使组与组之间的离差平方和的差异变小。

### 4.2 使用建议

- 样本量较小时，建议尝试不同的K值进行敏感性分析
- 对于重要结论，应重复进行多次检验以确保结果稳定
- 结合其他方差齐性检验方法（如Levene检验、Brown-Forsythe检验）进行综合判断

