# Wilcoxon检验分布推导
## 一、定义
\[W^+ = \sum_{j=1}^n j \cdot W_j\]
其中：
- \( j \) 是正秩（从 1 到 \( n \)），
- \( W_j \) 是符号变量。\( W_j = 1 \) 表示正秩为\(j\)的数是正数，\(W_j = 0\)表示其为负数。在零假设（总体分布对称于中位数 \( \theta \)）下，\(W_j \sim B(1, \frac{1}{2})\)

---------

## 二、近似分布
在非参数统计中，很多统计量都有渐近正态性的属性。尽管其证明通常相当复杂，但在实际操作中，我们可以通过编程实验，随机生成大量数据来验证这点。(严格证明还得靠数学)\(W^+\)在大样本的情况下，同样有渐进正态性的属性。因此我们只需要关注它的期望和方差即可。
### 独立性说明

需要证明 $W_1, W_2, \ldots, W_n$ 相互独立，且 $W_j \sim B(1, \frac{1}{2})$。

**证明思路**：

1. **原始观测的独立性**：$X_1, X_2, \ldots, X_n$ 相互独立。

2. **差值的独立性**：令 $Y_i = X_i - \theta$，则 $Y_1, Y_2, \ldots, Y_n$ 也相互独立。

3. **符号函数的独立性**：定义 $S_i = I(Y_i > 0)$。由于 $S_i$ 是 $Y_i$ 的Borel可测函数，根据"独立随机变量的可测函数仍独立"的性质，$S_1, S_2, \ldots, S_n$ 相互独立。

4. **绝对值与符号的独立性**：因为$S_i$不影响$|Y_i|$的取值，故$|Y_i|$ 与 $S_i$ 相互独立。

5. **秩排序的影响**：令 $\pi$ 是使得 $|Y_{\pi(1)}| < |Y_{\pi(2)}| < \cdots < |Y_{\pi(n)}|$ 的排列。$\pi$ 完全由绝对值序列决定。

6. **重排后的独立性**：定义 $W_j = S_{\pi(j)}$。由于：
   - $\pi$ 是绝对值序列的函数
   - 绝对值序列与符号序列 $S_1, \ldots, S_n$ 独立
   - 因此，对于固定的排列 $\pi$，$W_1, \ldots, W_n$ 只是独立符号序列的一个重排，仍保持独立性。

综上，$W_1, W_2, \ldots, W_n$ 相互独立，且每个 $W_j \sim B(1, \frac{1}{2})$。

### 期望
\[\begin{aligned}
E(W^+) &= E(\sum_{j=1}^n j Wj) = \sum_{j=1}^n E(j Wj) \\ &= \sum_{j=1}^n jE(W_j) = \frac{1}{2} \sum_{j=1}^n j \\ &= \frac{1}{2} \times \frac{(1 + n)n}{2} = \frac{(1 + n)n}{4}
\end{aligned}\]


### 方差
\(∵W_j\)之间相互独立 \(\implies Cov(W_i, W_j) = 0\)
\[\begin{aligned}
∴Cov(iW_i, jW_j) &= E(iW_i \cdot jW_j) - E(iW_i)E(jW_j) \\ &=ijE(W_i \cdot W_j) - ijE(W_i)E(W_j) \\ &= ij \left[E(W_i \cdot W_j)  - E(W_i)E(W_j)\right] \\ &= ij Cov(W_i, W_j) = 0
\end{aligned}\]

\[\begin{aligned}
∴Var(W^+) &= Var(\sum_{j=1}^n jW_j) = \sum_{j=1}^n Var(jW_j) \\ &= \sum_{j=1}^n j^2 \cdot Var(W_j) \\
&= \frac{1}{4} \times \frac{n(n+1)(2n+1)}{6} \\ &= \frac{n(n+1)(2n+1)}{24}
\end{aligned}\]

### 近似分布
当样本量足够大时(通常取n > 20)，我们认为：
\[W^+ \stackrel{.}{\sim} N(\frac{(1+n)n}{4}, \frac{n(n+1)(2n+1)}{24})\]

-------

## 三、精确分布
关于\(W^+\)的精确分布有多种求法；其中的生成函数法和递推公式法是最具有启发性的。

特别的，我们虽然可以直接构造生成函数，但更加通用的方法是使用矩母函数导出对应的生成函数。这是因为矩母函数本身是生成函数推导而来的，自然而然地具备了生成函数的特点，同时还有易于表示的优势。下面对这些方法做统一介绍。

### 暴力枚举法
暴力枚举法核心是"**定一移一**"。先固定住正秩，从\(1, 2, ..., n\)，然后确定每个秩的正负号。由于共有n个正秩，每个正秩都有2种可能的符号。因此容易得到共有\(2^n\)种情况。我们将所有情况列举出来后，分别计算每种情况对应的\(W^+\)的值即可。

### 递推公式法
递推公式法是一种间接方法。它不直接构造出通项公式，而是退而求其次，尝试构造前后两项或几项的关系。
我们不妨思考一下，\(P_n(W^+ = k)\)和\(P_{n-1}(W^+ = k)\)是否存在什么关系？不难发现:
- 如果正秩最大的数满足\(I(x_i > 0) = 0\)，那么\(P_n(W^+ = k) = P_{n-1}(W^+ = k)\); 
- 如果不满足\(I(x_i > 0)\)，那么要实现总体的\(W^+ = k\)，就需要\(P_{n-1}(W^+ = k - n)\)

综合上述上述两种情况，每种情况的发生各为\(\frac{1}{2}\)的概率，因此：
\[P_n(W^+ = k) = \frac{1}{2}P_{n-1}(W^+ = k) + \frac{1}{2}P_{n-1}(W^+ = k - n)\]

接下来完善一下取值范围，以确定递推式的适用范围：
- 当最大秩为\(n\)时，\(W^+ \in [0, \frac{(1+n)n}{2}]\)
- 当最大秩为\(n-1\)时，\(W^+ \in [0, \frac{n(n-1)}{2}]\)

令：\(0 \leq k \leq \frac{n(n-1)}{2}\)且\(0 \leq k-n \leq \frac{n(n-1)}{2} \implies\)
\[n \leq k \leq \frac{n(n-1)}{2}\]当\(k\)不在这一范围内时:
\(P_{n-1}(W^+ = k) = P_{n-1}(W^+ = k-n) = 0\)

利用递推公式，我们只需要枚举出\(n=1\)时的精确分布列，\(n \geq 2\)的情况都可以据此推导出来了。计算量相较过去明显减小。


### 直接构造生成函数法
生成函数法是解决复杂的排列组合类问题的强大工具。它将排列组合问题转化成了纯粹的代数问题，大大降低了问题的复杂性。
我们使用\(x^k\)编码\(w^+ = k\)的情况。对于从\(1, 2, ..., n\)的正秩，它们对应的数都有(正/负)两种情况。如果是正数，那么它们就为\(W^+\)贡献了对应的值，否则，它们不作任何贡献，即\(x^0 = 1\)。因此，构造的生成函数为：
\[G(x) = (1+x)(1+x^2)...(1+x^n) = \prod_{i=1}^n (1+x^i)\]只需拆括号得到其中\(x^k\)前面的系数即可知道\(W^+ = k\)的情况有多少种。再除以\(2^n\)就可以得到最后的概率。但需要注意，暴力拆括号不可取，因为直接拆括号运算还是和方法一的暴力枚举没有区别，需要做\(2^n\)次运算。

对于这个代数问题，我们需要理解"\(a\times (1 + x^n)\)"的含义。它可以拆成"\(a + a \times x^n\)"，用竖式可以看出其规律。例如\(a = G(2)\):
\[\begin{aligned}
G(2) &= 1 + x + x^2 + x^3 \\ G(2) \times x^3 &= x^3 + x^{4} + x^{5} + x^{6}
\end{aligned}\]
由于都是升幂排列，我们只需要将"\(a \times x^n\)"的最低幂和\(a\)的最高幂对齐，系数相加即可。即：
\[\begin{aligned}
幂&：0 \quad 1 \quad 2 \quad 3 \quad 4 \quad 5 \quad  6 \\ 
G(2)的系数&：1 \quad 1 \quad 1 \quad 1 \\ 
G(2) \times x^3的系数&：\qquad \qquad \,\,\, 1 \quad 1 \quad 1 \quad 1 \\
G(3)的系数&：1 \quad 1 \quad 1 \quad 2 \quad 1 \quad 1 \quad 1
\end{aligned}\]

于是，\(P_3(W^+ = k) = \frac{x^k的系数}{2^3}\)。例如，\(P_3(W^+ = 3) = \frac{2}{8}\)

需要注意，展开代数式并非总是容易的。但它给我们提供了关于代数的视角，让我们能用代数工具解决排列组合问题。

### 矩母函数法(MGF)
矩母函数法是生成函数法的更一般化方法。这源于矩母函数本身就是特殊的生成函数。如果说直接构造生成函数还需要仔细思考如何用\(x\)编码随机变量的取值，矩母函数法则是纯粹的计算了。

#### 矩母函数表达式
对于固定的 \( j \)，考虑随机变量 \( j W_j \)。其 MGF 为：
\[\begin{aligned}
M_{j W_j}(t) &= E[e^{t (j W_j)}] = P(W_j = 0) e^{t \cdot 0} + P(W_j = 1) e^{t \cdot j}\\ 
&= \frac{1}{2} \cdot 1 + \frac{1}{2} e^{t j} = \frac{1}{2} (1 + e^{t j})
\end{aligned}\]

由于 \( W_j \) 相互独立，\( W^+ \) 的 MGF 是各 \( j W_j \) 的 MGF 的乘积：
\[
\begin{aligned}
M_{W^+}(t) &= E[e^{t W^+}] = E\left[ e^{t \sum_{j=1}^n j W_j} \right] \\
&= \prod_{j=1}^n E\left[ e^{t j W_j} \right] = \prod_{j=1}^n \frac{1}{2} (1 + e^{t j}) \\
&= \frac{1}{2^n} \prod_{j=1}^n (1 + e^{t j})
\end{aligned}\]这就是 \( W^+ \) 的矩母函数的表达式。


#### 从矩母函数中获取精确分布
\(MGF\)的表达式 \( M_{W^+}(t) = \frac{1}{2^n} \prod_{j=1}^n (1 + e^{t j}) \) 正是一个生成函数。展开这个乘积，可以得到 \( e^{t k} \) 的线性组合，其中系数\(c_k\)对应 \( W^+ = k \) 的情况数。即：
\[
M_{W^+}(t) = \frac{1}{2^n} \sum_{k} c_k e^{t k} = \sum_{k} P(W^+ = k) e^{t k}
\]
不难看出，只要去掉矩母函数前的\(2^n\)，并将\(e^t\)替换成\(x\)，它就与我们之前构造的生成函数没有差别了。

#### 延伸
实际上，矩母函数的强大远不止于此。我们提到的递推公式法，实际上也可以从\(MGF\)推导而来。
由于\(M_n(t)\)有明确的表达式，因此我们可以轻松构建出\(M_n(t)\)和\(M_{n-1}(t)\)之间的关系。又因为\(M_n(t)\)本身就和\(P_n(W+ = k)\)有关。因此我们自然能建立起\(P_n\)和\(P_{n-1}\)之间的关系。


