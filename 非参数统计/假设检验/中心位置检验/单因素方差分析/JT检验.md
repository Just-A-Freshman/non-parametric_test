# JT检验
## 1. 概述
JT检验即Jonckheere-Terpstra检验。正如一般的假设检验问题有双边检验和单边检验一样，多样本问题的备择假设也可以具有方向性。JT检验就可以认为是多样本非参数检验中用于检验单调趋势的**单侧检验**。

检验问题：
$$\begin{aligned}
&H_0: M_1 = M_2 = ... = M_k \\
&H_1: M_1 \leq M_2 \leq ... \leq M_k
\end{aligned}$$注意为了满足$H_0$和$H_1$之间无重合，因此要求$H_1$中至少有一个严格不等式，如$M_1 < M_2$。它的基本思想和秩和检验很相似，即统计一个样本中观测值小于另外一个样本中观测值的个数。如果个数较大或较小，则可以认为大小关系是存在的。

虽然乍一看$JT$检验不需要编秩，但实际这种**计数**的方式和求秩和并无本质差异，秩次也可以化作计算比自己小的数的个数。因此，和那些以检验**位置参数差异**为目的的**混合编秩**检验一样，都要求每组数据的分布具有相似的形状(偏度、峰度)。

与参数检验（如检验单调趋势的方差分析）相比，$JT检验$的统计功效较低；但在非参数检验中，其功效高于无方向的 Kruskal-Wallis 检验（当存在单调趋势时）。

## 2. 统计量
记：
- $W_{ij} = \#(X_{ik} < X_{jl}, k \in I_{n_i}, l \in I_{n_j})$
- $W_{i=j} = \#(X_{ik} = X_{jl}, k \in I_{n_i}, l \in I_{n_j})$

那么统计量：
$$
J = \sum_{i < j} (W_{ij} + \frac{1}{2}W_{i=j})
$$

我们简要示范一下其计算，假设有如下三组数据：
```
A = [3.7, 3.7, 3.0]
B = [7.3, 5.2, 5.3]
C = [9.0, 4.9, 7.1]
```
$A \to 1, B \to 2, C \to 3$，如$X_{12}$表示$A$组的第2个数据。在计算$W_{12}$之前，我们先对$A和B$进行组合：
```
AB = [
    (3.7, 7.3), (3.7, 5.2), (3.7, 5.3),
    (3.7, 7.3), (3.7, 5.2), (3.7, 5.3),
    (3.0, 7.3), (3.0, 5.2), (3.0, 5.3)
]
```
统计$(a, b)$中$a < b$的组合数，即$W_{12}$；统计$(a, b)$中$a = b$的组合数，即$W_{1 = 2}$，那么$W_{12} = 9, W_{1 = 2} = 0$；

同理，我们组合$A和C$，$B和C$，并计算得到：
- $W_{13} = 9，W_{1=3} = 0$
- $W_{23} = 5，W_{2=3} = 0$

最后，$J = (9 + 0) + (9 + 0) + (5 + 0) = 23$

## 3. 拒绝域
通过统计量的计算过程可以看出，$J$越大，表明这种自左向右递增的趋势越强，反之同理。因此：
- 如果备择假设是：$H_1: M_1 \leq M_2 \leq ... \leq M_k$，那么$J > J_{1 - \alpha}$时落入拒绝域；
- 如果备择假设是：$H_1: M_1 \geq M_2 \geq ... \geq M_k$，那么$J < J_{\alpha}$时落入拒绝域；

## 4. 分布
### 4.1 小样本
小样本精确分布查表。需要补充，精确表只考虑**无结情况**，此时：
$$J = \sum_{i < j} W_{ij}$$此外，精确表通常只有右侧检验的临界值，即$P(J \geq J_{1 - \alpha})$。这是因为$W_{xy}$本身是对称的，因此$J$检验统计量也是对称的，即
$$
\sum_{i < j} W_{ij} + \sum_{i < j} W_{ji} = \sum_{i < j} n_i n_j = J_{\max}
$$因此，左侧检验的临界值就是：
$$
P(J \leq J_{\alpha}) = P(J \geq J_{\max} - J_{1 - \alpha})
$$

### 4.2 大样本
大样本采用正态近似。其中，无结情况下：
- 期望
$$E(J) = \frac{1}{4} \left(N^2 - \sum_{i=1}^k n_i^2 \right)$$
- 方差
$$Var(J) = \frac{1}{72} \left[N^2 (2N + 3) - \sum_{i=1}^k n_i^2(2n_i + 3)\right]$$

当样本量足够大，即$\min(n_i) > c$（$c$通常取10）时：
$$
Z = \frac{J - E(J)}{\sqrt{Var(J)}} \stackrel{.}{\sim} N(0, 1)
$$
大样本的有结修正公式非常复杂，此处我们不作展示。

## 5. R代码实现
检验A、B和C三组的中心位置是否有递增趋势
```
A = c(3.7, 3.7, 3.0, 3.9, 2.7)
B = c(7.3, 5.2, 5.3, 5.7, 6.5)
C = c(9.0, 4.9, 7.1, 8.7)
```

实现代码（安装clinfun库）：
```
data = c(
  3.7, 3.7, 3.0, 3.9, 2.7,
  7.3, 5.2, 5.3, 5.7, 6.5,
  9.0, 4.9, 7.1, 8.7
)

groups = factor(c(rep(1, 5), rep(2, 5), rep(3, 4)), ordered = TRUE)



clinfun::jonckheere.test(
  data,
  groups,
  alternative = "increasing",
  nperm = 5000
)
```
检验结果：
```
	Jonckheere-Terpstra test

data:  
JT = 59, p-value = 0.001
alternative hypothesis: increasing
```
p-value < 0.05，因此认为三组数据有逐渐递增的趋势。这里补充说明一下代码的重点：
- groups分组的数据类型必须是**有序**因子(上述指定了ordered = TRUE)，因为趋势性检验对分组有明确的先后顺序要求；
- 有结或样本量很小的情况下，使用理论分布计算的不准确，可以考虑用nperm置换检验。其基本原理是：先计算出原始数据的$J$值。因为在原假设成立的情况下，每组数据中心位置一样。因此我们可以将数据混合后随意分组，每次分组都计算一次$J$值，重复$k$次(上述代码指定了nperm = 5000次)。用频率逼近概率(蒙特卡洛的思想)，从而计算出原始数据$J$值的极端程度；

$JT$检验的函数文档：[https://www.rdocumentation.org/packages/clinfun/versions/1.1.5/topics/jonckheere.test](https://www.rdocumentation.org/packages/clinfun/versions/1.1.5/topics/jonckheere.test)