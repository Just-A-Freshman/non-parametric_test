# Friedman秩方差分析
## 一、基本概念
假设我们要公平比较A、B、C三种肥料的效果，但有30块肥力不同的土地。如何分配才科学？

**方法一：完全随机设计**
- 把三种肥料完全随机分给30块地，每种10块。
- 适合土地肥力差异不大的情况。随机分组后各组的**平均肥力**不会差太多。

**方法二：完全随机区组设计**
- 当土地肥力差异很大时，随机分组可能造成系统性误差——但凡某个组多分到几块肥地，组与组的差距就会被迅速拉大。
- 解决办法是**分层**：先按肥力高低把土地分成5个区组（每个区组6块肥力相近的地），然后在每个区组内随机分配A、B、C三种肥料。
- 这样保证了每种肥料在各级肥力土地中都有分布，比较更公平。

**核心概念**
- **处理**：要研究的对象（这里指A、B、C三种肥料）
- **区组**：为控制干扰因素而划分的同质分组（这里指按肥力划分的土地组）

两种设计的目标是一致的：都是为了使分组更公平，使不同处理间的差距仅仅是处理本身引起的。

## 二、思想
Friedman秩方差分析就是完全随机区组设计，也叫双因素方差分析。为了能让不同区组，同一处理的数据具有可比性，一种朴素的想法是让不同区组的平均水平全部对齐。Friedman采取的策略是“**区组内编秩**”。通过这一操作，每个区组的秩和以及平均秩都相同，从而对齐了各组的水平。(实际操作见六)

## 三、统计量
记$k$为处理数，$b$为区组数。总样本量则为$N = kb$。将Friedman的检验统计量记为Q，和Kruskal-Wallis单因素方差分析一样：
\[Q = \frac{SSA}{MST}\]

但由于编秩方式的不同，$SSA$和$MST$的计算结果和Kruskal-Waillis的计算得到结果有差别：
1. 总均值：混合编秩时总秩和为$\frac{(N + 1)N}{2}$，分区组编秩后，每个区组的秩和为$\frac{(1 + k)k}{2}$，总秩和变成了$\frac{bk(1 + k)}{2}$，这同时影响$SSA$和$SST$的计算；
2. 自由度：混合编秩时，总秩和是确定的，因此自由度减$1$；分区组编秩时，每个区组的总秩和都是确定的，因此总自由度要减$b$。这影响着$MST$的计算。

据此，我们可以计算得到：
1. **SSA**（也被写作SSt）
\[\begin{aligned}
SSA &= b \cdot \sum_{j=1}^k \left(\bar{R_{.j}} - \frac{b(1+k)}{2}\right)^2 \\
&=  \frac{\sum_{j=1}^k R_{.j}^2}{b} - \frac{bk(k + 1)^2}{4}
\end{aligned}\]

2. **MST**
\[\begin{aligned}
MST &= \frac{SST}{kb - b} \\
&= \frac{\sum_{i=1}^b \sum_{j=1}^k \left(R_{ij} - \frac{b(1 + k)}{2}\right)^2}{b(k - 1)} \\
&= \frac{k(k + 1)}{12}
\end{aligned}\]

化简得到最终的**计算式**：
\[
Q = \frac{12}{bk(k + 1)} \sum_{j=1}^k R_{i.}^2 - 3b(k + 1)
\]

当样本数据有结时，需要对$H$进行修正：$H_c = H \cdot c$，修正系数:
\[c = 1 / \frac{\sum_{i=1}^b \sum_{j=1}^k (\tau_{i, j}^3 - \tau_{i,j})}{bk(k^2 - 1)}\]

该统计量衡量了各处理平均秩之间的变异程度。如果所有处理的效果完全相同，则每个处理获得的秩和应大致相等，Q 值会接近零。反之，处理效应差异越大，秩和间的差异也越大，Q 值随之增大。

## 四、分布
### 小样本
教科书上并没有直接对$Q$进行精确分布制表。因为它和一个$W$统计量等价，即$W = \frac{Q}{b(k - 1)}$。将$Q$转化成$W$后，我们就可以通过查询$W$表判断$Q$是否落入拒绝域了。

### 大样本
和Kruskal-Waillis一样，$SSA/MST$可以看成$k - 1$个近似独立同分布的标准正态分布的平方和。当样本量足够大时(要求$k$固定，$b \to \infty$)，满足：
\[Q \sim \chi^2(k - 1)\]

## 五、多重比较
众所周知，Kruskal-Wallis的多重比较采用的是：
\[
\frac{\bar{R_i} - \bar{R_{j}}}{\sqrt{\left(\frac{1}{n_i} + \frac{1}{n_j}\right) MST}} \sim N(0, 1)
\]只需要将$n \to b$就是Hollander-Wolfe的两处理间比较。可以说并没有任何差异。为了体现它构造统计量的不同，Hollander-Wolfe还特地把分子上的**两个平均秩作差**换成了**秩和作差**(上下同乘以$b$)：
\[
\frac{R_{i.} - R_{j.}}{\sqrt{\frac{2}{b} \cdot MST \cdot b^2}} \sim N(0, 1)
\]分母稍加化简就是$SE = \sqrt{kb(k+1) / 6}$


## 六、实际案例

假设在某农业实验中，比较三种肥料（A, B, C）在五个不同肥力区组（I, II, III, IV, V）下的作物产量，数据如下：

```r
A <- c(20.3, 21.2, 18.2, 18.6, 18.5)
B <- c(25.6, 24.7, 19.3, 19.3, 20.7)
C <- c(24.0, 23.1, 20.6, 19.8, 21.4)
mat <- cbind(A, B, C)
rownames(mat) <- c('I', 'II', 'III', 'IV', 'V')

> mat
       A    B    C
I   20.3 25.6 24.0
II  21.2 24.7 23.1
III 18.2 19.3 20.6
IV  18.6 19.3 19.8
V   18.5 20.7 21.4
```

**第一步：区组内编秩**
在每个区组（每一行）内，将产量从低到高排名。
```r
ranks <- t(apply(mat, 1, rank))


> ranks
    A B C
I   1 3 2
II  1 3 2
III 1 2 3
IV  1 2 3
V   1 2 3
```

**第二步：计算统计量与p值**
```
b <- nrow(mat)
k <- ncol(mat)
SqRi <- apply(ranks, 2, sum)^2
Q <- (12 / (b*k*(k+1))) * sum(SqRi) - 3*b*(k+1)
p.value <- pchisq(Q, k - 1, lower.tail = FALSE)

> Q
[1] 7.6

> p.value
[1] 0.02237077

```
使用R的内置函数```friedman.test(mat)```可以验证这一结果：
```
> friedman.test(mat)

	Friedman rank sum test

data:  mat
Friedman chi-squared = 7.6, df = 2, p-value = 0.02237
```

在显著性水平α=0.05下，p值（0.022）小于0.05，拒绝原假设。可以认为三种肥料对作物产量的影响存在显著差异。
