# Cochran检验
## 一、动机
将A,B,C三种榨汁机分为10位家庭主妇使用, 喜欢——1分，不喜欢——0分，得到如下数据：
```r
A <- c(0, 0, 0, 1, 0, 0, 0, 0, 0, 1)
B <- c(1, 1, 0, 1, 0, 1, 0, 0, 1, 1)
C <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 0)
```
作出如下假设：
\[\begin{aligned}
&H_0: 三组榨汁机受欢迎程度相同 \\ 
&H_1: 三组榨汁机受欢迎程度存在显著性差异。
\end{aligned}\]
从数据可以得到：$C_1 = 2；C_2 = 6；C_3 = 9；E = \frac{17}{3} \approx 5.6667；$同时有处理数$k = 3$，区组数$b = 10$；

首先，让我们考虑**Friedman秩方差分析**：
Friedman采用区组内编秩。然而数值只有0和1，编秩后的数据同样只会映射到两个数值，导致数据间的变异性极小。因为组与组之间的差距无法拉开，计算得到的统计量$Q$会很小，几乎总是无法拒绝  原假设。

再来看**卡方拟合优度检验**。三组榨汁机受欢迎程度相同，等价于它们的总评分服从期望为$E$的均匀分布。计算卡方统计量会得到：
\[\begin{aligned}
\chi^2 &= \sum \frac{(O-E)^2}{E} \\ 
&= \frac{(2-5.667)^2}{5.667} + \frac{(6-5.667)^2}{5.667} + \frac{(9-5.667)^2}{5.667} \\
& \approx 4.353 < \chi_{0.05}^2(2) = 5.991
\end{aligned}\]
不能拒绝原假设，即认为三组榨汁机受欢迎程度是相同的。这似乎有些违背我们的直觉？

实际上，这正是缺乏考虑**相关性**的原因。家庭主妇对于榨汁机的评分是受其个人偏好影响的，如倾向于一律喜欢或不喜欢。无论是哪种倾向，都会在一定程度上**拉近榨汁机之间的评分**，进而**低估**榨汁机之间的差异性。

怎么办呢？如果我们能**改变数据**，我们可以：
- 找到30名家庭主妇，并且为每个榨汁机都随机不重叠地分配10名主妇进行评分
- 主妇A1对榨汁机A的评分与主妇B1对榨汁机B的评分是独立的
- 每个榨汁机对应的10名主妇的总体评分倾向不会有太大区别。

这正是完全随机设计的思想。在这种情况下，使用卡方检验就没有任何问题了！然而现实是残酷的。找到30名主妇并且还只对一个榨汁机评分，相比原来的数据方案，成本要高昂得多。如果不改变数据，我们如何给出有说服力的检验呢？


## 二、解决策略
解决的关键在于如何**将主妇的评分倾向考虑在内**。Cochran的想法是:
- 在原假设成立的情况下，三个榨汁机得到满意概率是相同的
- **满意的概率取决于妇女本身**。比如在样本中，这名妇女给两个榨汁机打了满意，我们就认为她给满意的概率是$\frac{2}{3}$

于是，对于一名妇女$i$而言，它的每次评分$O_{ij}$都将服从两点分布，即：
\[O_{ij} \sim B(1, p_i), \quad p_i = \frac{\sum_{j=1}^k O_{ij}}{k} = \frac{O_i}{k}\]

这样，在原假设下，我们就可以将数据的生成过程看出是10个不同的两点分布分别独立重复实验3次得到的数据。

接着，我们仿照卡方拟合优度检验的思路，将问题转化为检验三个榨汁机的总评分是否服从均匀分布。记第$j$个榨汁机的总评分为$O_j$，可以得到三台榨汁机的**期望**：
\[\begin{aligned}
E(O_j) &= E(\sum_{i=1}^b O_{ij}) = \sum_{i=1}^b E(O_{ij}) = \sum_{i=1}^b p_i \\ &= \frac{\sum \sum O_{ij}}{k} = \frac{N}{k}
\end{aligned}\]

对于方差的计算，我们需要注意两点：
1. 不同家庭主妇(区组)之间的评分是相互独立的
2. $p_i$是通过样本估计的，因此在计算$O_{ij}$的方差时直接使用$p_i(1 - p_i)$是有偏的，原本的自由度$k \to (k - 1)$，方差要适当变大(这就是Cochran最后提到的调整系数的来源)。

因此，三组榨汁机的**方差**为：
\[\begin{aligned}
D(O_j) &= D(\sum_{i=1}^b O_{ij}) = \sum_{i=1}^b D(O_{ij}) \\ 
&= \frac{k}{k-1} \sum_{i=1}^b p_i (1 - p_i)
\end{aligned}\]

我们不妨来算一下例子中的卡方统计量。其中：
- $E(O_j) = \frac{C_1 + C_2 + C_3}{3} = \frac{17}{3} \approx 5.667$
- 观察到有9名妇女对榨汁机的满意与不满意之比都是1:2或2:1。因为比例对称，所以它们的方差都是$\frac{1}{3} \times \frac{2}{3} = \frac{2}{9}$；还有1名妇女全部评1分，方差就是0；于是：
\[D(O_j) = 9 \times (\frac{3}{2} \times \frac{2}{9}) + 0 = 3\]

卡方统计量就是：
\[\begin{aligned}
\chi^2 &= \sum_{j=1}^k \frac{(O_j-E_j)^2}{D_j} \\ 
&= \frac{(2-5.667)^2}{3} + \frac{(5-5.667)^2}{3} + \frac{(9-5.667)^2}{3} \\
& \approx 8.22 > \chi_{0.05}^2(2) = 5.991
\end{aligned}\]

此时，我们就能拒绝原假设了！

## 三、数学化
Cochran的核心思想就是将区组效应考虑到了一个二项分布中。它将这个卡方统计量称为$Q$；让我们将其进一步化简。

首先注意到对应$D(O_j)$，我们可以进一步将$p_i$的表达式代入：
\[\begin{aligned}
D(O_j) &= \frac{k}{k-1} \sum_{i=1}^b (\frac{O_i}{k} \cdot \frac{k - O_i}{k}) \\
&= \frac{1}{k-1} (N - \sum_{i=1}^b O_i^2 / k)
\end{aligned}\]

注意$E(O_j), D(O_j)$的值和具体的$j$无关；对于卡方分布的分子部分：
\[\begin{aligned}
\sum_{j=1}^k (O_j - E_j)^2 &= \sum O_j^2 - 2 \sum O_j E_j + \sum E_j^2 \\
&= \sum O_j^2 - 2 \cdot \frac{N}{k} \cdot N + k \cdot (\frac{N}{k})^2 \\
&= \sum O_j^2 - N^2 / k
\end{aligned}\]

因此，最终的$Q统计量$：
\[Q = \sum_{j=1}^k \frac{(O_j-E_j)^2}{D_j} = \frac{(k-1)\left[\sum_{j=1}^k O_j^2 - N^2 / k\right]}{N - \sum_{i=1}^b O_i^2 / k}\]

让我们像刚才一样计算一下：
- $N = C_1 + C_2 + C_3 = 17$
- $\sum_{j=1}^k O_j^2 = C_1^2 + C_2^2 + C_3^2 = 2^2 + 6^2 + 9^2 = 121$
- $\sum_{i=1}^b O_i^2 = 5 \times 2^2 + 4 \times 1^2 + 1 \times 3^2 = 33$

因此：
\[Q = \frac{2 \times (121 - 17^2 / 3)}{17 - 33 / 3} \approx 8.22\]
和之前的计算结果保持一致。

## 四、R代码实现
```
library(DescTools)

if (sys.nframe() == 0) {
  A <- c(0, 0, 0, 1, 0, 0, 0, 0, 0, 1)
  B <- c(1, 1, 0, 1, 0, 1, 0, 0, 1, 1)
  C <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 0)
  mat = cbind(A, B, C)
  CochranQTest(mat)
}
```
由于其计算非常简单，我们还能顺手实现一下：
```
Cochran.Qtest = function(data) {
  N = sum(data)
  k = ncol(data)
  sumSquareOj = sum(apply(data, 2, sum)^2)
  sumSquareOi = sum(apply(data, 1, sum)^2)
  Q = (k - 1) * (sumSquareOj - N^2 / k) /
      (N - sumSquareOi / k)
  p.value <- pchisq(Q, k - 1, lower.tail = FALSE)

  result <- list(
    statistic = c(Q = Q),
    parameter = c(df = k - 1),
    p.value = p.value,
    method = "Cochran's Q test",
    data.name = deparse(substitute(data))
  )
  class(result) <- "htest"
  return(result)
}
```

运行结果：
```
Cochran's Q test

data:  mat
Q = 8.2222, df = 2, p-value = 0.01639
```
和我们的计算结果一致。因为p值小于0.05，因此拒绝原假设。认为三个榨汁机的受欢迎程度有差异。

## 五、写在最后
由Cochran的推导过程我们可以看出来，Cochran只适用于**有区组效应**的**二分类数据**。而且二分类数据必须转化成0-1形式。尽管其应用范围略显狭窄，但在这种特定情况下检验效能还是相当不错的！

另外，因为Cochran关键是这个两点分布：
\[O_{ij} \sim B(1, p_i)\]
我们要求$\sum_{j=1}^k \frac{(O_j-E_j)^2}{D_j}$服从卡方分布，其实就是要求$O_j = \sum_{i=1}^b O_{ij}$要能近似服从正态分布。$O_{ij}$服从两点分布，由中心极限定理可以推得：$b$个**相互独立**且服从**概率不同**的两点分布的随机变量的和，在$b$足够大时会近似服从于正态分布。因此我们要求$b$即区组数应该足够大，这样才能保证$O_j$近似服从正态。在我们的案例中，区组数$b = 10$较大，因此效果还是不错的。

ps:如何判断统计量是否服从正态分布？
1. 统计量是「多个相互**独立项**之和 / 均值」且项数越多越准（通常≥30 就有非常好的近似效果）
2. 每个项都较小且取值范围有限，没有某个项能主导结果；
3. 不存在方差极大的项，且总波动随项数增长而变大而不会收敛。